import{_ as l}from"./chunks/fig4a-class-distribution.Dfr52f7j.js";import{_ as e,C as p,c as h,o as a,a2 as i,b as r,w as n,a as k,G as d,a3 as g}from"./chunks/framework.nRfFlDZQ.js";const A=JSON.parse('{"title":"Chương 6: xView1 Hạng 1: Giải Pháp Reduced Focal Loss","description":"","frontmatter":{},"headers":[],"relativePath":"chuong-06-xview-challenges/muc-01-xview1-object-detection/02-giai-nhat.md","filePath":"chuong-06-xview-challenges/muc-01-xview1-object-detection/02-giai-nhat.md","lastUpdated":null}'),c={name:"chuong-06-xview-challenges/muc-01-xview1-object-detection/02-giai-nhat.md"};function o(E,s,b,y,u,F){const t=p("Mermaid");return a(),h("div",null,[s[1]||(s[1]=i('<h1 id="chuong-6-xview1-hang-1-giai-phap-reduced-focal-loss" tabindex="-1">Chương 6: xView1 Hạng 1: Giải Pháp Reduced Focal Loss <a class="header-anchor" href="#chuong-6-xview1-hang-1-giai-phap-reduced-focal-loss" aria-label="Permalink to &quot;Chương 6: xView1 Hạng 1: Giải Pháp Reduced Focal Loss&quot;">​</a></h1><h2 id="tong-quan" tabindex="-1">Tổng Quan <a class="header-anchor" href="#tong-quan" aria-label="Permalink to &quot;Tổng Quan&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Thuộc tính</th><th>Giá trị</th></tr></thead><tbody><tr><td><strong>Hạng</strong></td><td>Hạng 1</td></tr><tr><td><strong>Tác giả</strong></td><td>Nikolay Sergievskiy, Alexander Ponamarev</td></tr><tr><td><strong>Đơn vị</strong></td><td>Nhà nghiên cứu độc lập</td></tr><tr><td><strong>Điểm Public LB</strong></td><td>31.74 mAP</td></tr><tr><td><strong>Điểm Private LB</strong></td><td>29.32 mAP</td></tr><tr><td><strong>Cải thiện vs Baseline</strong></td><td>+111%</td></tr><tr><td><strong>Bài báo</strong></td><td><a href="https://arxiv.org/abs/1903.01347" target="_blank" rel="noreferrer">arXiv:1903.01347</a></td></tr><tr><td><strong>Giải thưởng</strong></td><td>Phần của $100,000 USD</td></tr></tbody></table><hr><h2 id="_1-tong-quan-va-boi-canh" tabindex="-1">1. Tổng Quan và Bối Cảnh <a class="header-anchor" href="#_1-tong-quan-va-boi-canh" aria-label="Permalink to &quot;1. Tổng Quan và Bối Cảnh&quot;">​</a></h2><h3 id="_1-1-van-đe-can-giai-quyet" tabindex="-1">1.1. Vấn Đề Cần Giải Quyết <a class="header-anchor" href="#_1-1-van-đe-can-giai-quyet" aria-label="Permalink to &quot;1.1. Vấn Đề Cần Giải Quyết&quot;">​</a></h3><p>xView Challenge 2018 đặt ra bài toán object detection với 60 lớp đối tượng trong ảnh vệ tinh WorldView-3 độ phân giải cao (0.3m GSD). Thách thức chính không chỉ nằm ở số lượng lớp mà còn ở sự mất cân bằng cực kỳ nghiêm trọng giữa các lớp. Trong hơn 1 triệu annotations của dataset, hai lớp phổ biến nhất - Small Car và Building - chiếm tới 60% tổng số instances, trong khi các lớp hiếm như Railway Vehicle chỉ có vài trăm samples.</p><p><img src="'+l+`" alt="Class Distribution Challenge"><em>Hình 1: Phân bố mất cân bằng nghiêm trọng giữa các lớp trong xView dataset</em></p><p>Các phương pháp object detection tiêu chuẩn tại thời điểm đó (2018) như Faster R-CNN hay RetinaNet gặp khó khăn với class imbalance. Focal Loss được Lin et al. đề xuất năm 2017 là một bước tiến quan trọng, nhưng nhóm tác giả phát hiện ra rằng áp dụng trực tiếp Focal Loss cho Region Proposal Network (RPN) trong Faster R-CNN dẫn đến một nghịch lý: thay vì cải thiện, nó làm giảm đáng kể recall của proposals.</p><h3 id="_1-2-insight-chinh-nghich-ly-focal-loss-trong-rpn" tabindex="-1">1.2. Insight Chính: Nghịch Lý Focal Loss trong RPN <a class="header-anchor" href="#_1-2-insight-chinh-nghich-ly-focal-loss-trong-rpn" aria-label="Permalink to &quot;1.2. Insight Chính: Nghịch Lý Focal Loss trong RPN&quot;">​</a></h3><p>Focal Loss được thiết kế để giảm trọng số của các easy examples, tập trung learning capacity vào hard examples. Trong single-stage detector như RetinaNet, điều này hoạt động tốt vì mọi anchor đều được classify trực tiếp. Tuy nhiên, trong two-stage detector như Faster R-CNN, RPN có nhiệm vụ đặc biệt: tạo ra proposals chất lượng cao để gửi cho Fast R-CNN classifier ở giai đoạn sau.</p><p><strong>Vấn đề:</strong> Khi Focal Loss down-weight các easy negative examples trong RPN, nó cũng vô tình down-weight những negative examples quan trọng ở vùng biên của objects. Kết quả là RPN học cách tránh những vùng này, dẫn đến proposals không bao phủ đầy đủ các objects và recall giảm.</p><p><strong>Quan sát thực nghiệm:</strong></p><ul><li>Focal Loss chuẩn (γ=2.0) giảm recall của RPN từ ~95% xuống ~85%</li><li>Proposal quality giảm ảnh hưởng đến toàn bộ pipeline detection</li><li>Hiệu ứng này đặc biệt nghiêm trọng với các lớp hiếm</li></ul><h3 id="_1-3-đong-gop-reduced-focal-loss" tabindex="-1">1.3. Đóng Góp: Reduced Focal Loss <a class="header-anchor" href="#_1-3-đong-gop-reduced-focal-loss" aria-label="Permalink to &quot;1.3. Đóng Góp: Reduced Focal Loss&quot;">​</a></h3><p>Để giải quyết vấn đề trên, Sergievskiy và Ponamarev đề xuất Reduced Focal Loss - một biến thể của Focal Loss với cơ chế weighting thích ứng:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>RFL(pt) = {</span></span>
<span class="line"><span>    -αt * log(pt)                               nếu pt &lt; threshold</span></span>
<span class="line"><span>    -αt * ((1-pt)^γ / threshold^γ) * log(pt)    nếu pt &gt;= threshold</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>Ý tưởng cốt lõi:</strong></p><ul><li>Dưới threshold (mặc định 0.5): Sử dụng standard cross-entropy loss, không giảm weight</li><li>Trên threshold: Áp dụng focal weighting đã được scale để đảm bảo continuity tại threshold</li></ul><p><strong>Tại sao hiệu quả:</strong></p><ul><li>Các hard examples (pt &lt; threshold) nhận full gradient, đảm bảo RPN học detect chúng</li><li>Các easy examples (pt &gt;= threshold) vẫn được down-weighted, xử lý class imbalance</li><li>Cân bằng giữa recall maintenance và hard example mining</li></ul><hr><h2 id="_2-đoi-moi-ky-thuat-chinh" tabindex="-1">2. Đổi Mới Kỹ Thuật Chính <a class="header-anchor" href="#_2-đoi-moi-ky-thuat-chinh" aria-label="Permalink to &quot;2. Đổi Mới Kỹ Thuật Chính&quot;">​</a></h2><h3 id="_2-1-phan-tich-toan-hoc-reduced-focal-loss" tabindex="-1">2.1. Phân Tích Toán Học Reduced Focal Loss <a class="header-anchor" href="#_2-1-phan-tich-toan-hoc-reduced-focal-loss" aria-label="Permalink to &quot;2.1. Phân Tích Toán Học Reduced Focal Loss&quot;">​</a></h3><p><strong>Standard Focal Loss (Lin et al., 2017):</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>FL(pt) = -αt * (1 - pt)^γ * log(pt)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Với pt là predicted probability cho true class. Khi γ &gt; 0:</p><ul><li>pt → 1 (easy positive): (1-pt)^γ → 0, loss rất nhỏ</li><li>pt → 0 (hard positive): (1-pt)^γ → 1, loss full</li></ul><p><strong>Reduced Focal Loss:</strong> Thêm threshold th để chia không gian probability thành hai vùng:</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> reduced_focal_loss</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pt, alpha, gamma, th</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> th:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Hard example: use standard CE</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">alpha </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> log(pt)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Easy example: use scaled focal weighting</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        focal_weight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pt) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gamma) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (th </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gamma)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">alpha </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> focal_weight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> log(pt)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>Đảm bảo continuity:</strong> Tại pt = th:</p><ul><li>Left limit: -α * log(th)</li><li>Right limit: -α * ((1-th)^γ / th^γ) * log(th)</li></ul><p>Với γ = 2 và th = 0.5: (0.5)^2 / (0.5)^2 = 1, nên hai limit bằng nhau.</p><h3 id="_2-2-anh-huong-đen-rpn-training" tabindex="-1">2.2. Ảnh Hưởng Đến RPN Training <a class="header-anchor" href="#_2-2-anh-huong-đen-rpn-training" aria-label="Permalink to &quot;2.2. Ảnh Hưởng Đến RPN Training&quot;">​</a></h3><p><strong>Thực nghiệm so sánh (trên xView dataset):</strong></p><table tabindex="0"><thead><tr><th>Loss Function</th><th>RPN Recall @1000</th><th>Final mAP</th></tr></thead><tbody><tr><td>Standard CE</td><td>94.2%</td><td>24.1</td></tr><tr><td>Focal Loss (γ=2)</td><td>86.5%</td><td>22.8</td></tr><tr><td><strong>Reduced Focal Loss</strong></td><td><strong>93.8%</strong></td><td><strong>28.5</strong></td></tr></tbody></table><p>Reduced Focal Loss gần như khôi phục lại recall của standard CE trong khi vẫn có lợi ích của hard example mining cho Fast R-CNN head.</p><h3 id="_2-3-iou-aware-loss-adjustment" tabindex="-1">2.3. IoU-Aware Loss Adjustment <a class="header-anchor" href="#_2-3-iou-aware-loss-adjustment" aria-label="Permalink to &quot;2.3. IoU-Aware Loss Adjustment&quot;">​</a></h3><p>Ngoài Reduced Focal Loss cho classification, nhóm tác giả cũng áp dụng IoU-aware weighting cho regression loss:</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iou_weighted_smooth_l1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pred_box, target_box, pred_class):</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Compute IoU between predicted and target boxes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    iou </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> compute_iou(pred_box, target_box)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Standard smooth L1 loss</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    base_loss </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> smooth_l1(pred_box, target_box)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Weight by IoU - prioritize well-localized predictions</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    weight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> iou </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Squared IoU for stronger emphasis</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> weight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> base_loss</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>Lý do:</strong></p><ul><li>Boxes với IoU cao đáng tin cậy hơn, nên gradients từ chúng should be emphasized</li><li>Boxes với IoU thấp có thể là noise, giảm contribution</li></ul><h3 id="_2-4-class-balanced-undersampling" tabindex="-1">2.4. Class-Balanced Undersampling <a class="header-anchor" href="#_2-4-class-balanced-undersampling" aria-label="Permalink to &quot;2.4. Class-Balanced Undersampling&quot;">​</a></h3><p>Để xử lý extreme class imbalance, áp dụng undersampling cho các lớp phổ biến:</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> balanced_sampling</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(images, annotations, target_classes, drop_prob):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Randomly drop instances of common classes during training.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Args:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        target_classes: [&#39;Small Car&#39;, &#39;Building&#39;] - classes to undersample</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        drop_prob: 0.5 - probability of dropping each instance</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> img_id, img_anns </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> annotations.items():</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ann </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> img_anns:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ann[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;class&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> target_classes:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> random.random() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> drop_prob:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    ann[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ignore&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> True</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Mark as ignored</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> annotations</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>Kết quả:</strong></p><ul><li>Cải thiện mAP cho rare classes từ ~5% lên ~18% (+260%)</li><li>Common classes vẫn maintain accuracy do có đủ samples</li></ul><hr><h2 id="_3-kien-truc-va-trien-khai" tabindex="-1">3. Kiến Trúc và Triển Khai <a class="header-anchor" href="#_3-kien-truc-va-trien-khai" aria-label="Permalink to &quot;3. Kiến Trúc và Triển Khai&quot;">​</a></h2><h3 id="_3-1-base-architecture-fpn-faster-r-cnn" tabindex="-1">3.1. Base Architecture: FPN + Faster R-CNN <a class="header-anchor" href="#_3-1-base-architecture-fpn-faster-r-cnn" aria-label="Permalink to &quot;3.1. Base Architecture: FPN + Faster R-CNN&quot;">​</a></h3>`,50)),(a(),r(g,null,{default:n(()=>[d(t,{id:"mermaid-329",class:"mermaid",graph:"flowchart%20TB%0A%20%20%20%20subgraph%20Backbone%5BBackbone%3A%20ResNet-50%5D%0A%20%20%20%20%20%20%20%20C2%5BConv2%3A%20256ch%3Cbr%2F%3E1%2F4%5D%0A%20%20%20%20%20%20%20%20C3%5BConv3%3A%20512ch%3Cbr%2F%3E1%2F8%5D%0A%20%20%20%20%20%20%20%20C4%5BConv4%3A%201024ch%3Cbr%2F%3E1%2F16%5D%0A%20%20%20%20%20%20%20%20C5%5BConv5%3A%202048ch%3Cbr%2F%3E1%2F32%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20FPN%5BFeature%20Pyramid%20Network%5D%0A%20%20%20%20%20%20%20%20P2%5BP2%3A%20256ch%3Cbr%2F%3E1%2F4%5D%0A%20%20%20%20%20%20%20%20P3%5BP3%3A%20256ch%3Cbr%2F%3E1%2F8%5D%0A%20%20%20%20%20%20%20%20P4%5BP4%3A%20256ch%3Cbr%2F%3E1%2F16%5D%0A%20%20%20%20%20%20%20%20P5%5BP5%3A%20256ch%3Cbr%2F%3E1%2F32%5D%0A%20%20%20%20%20%20%20%20P6%5BP6%3A%20256ch%3Cbr%2F%3E1%2F64%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20RPN%5BRegion%20Proposal%20Network%5D%0A%20%20%20%20%20%20%20%20R1%5B3x3%20Conv%20%2B%20ReLU%5D%0A%20%20%20%20%20%20%20%20R2%5BCls%3A%202k%20anchors%3Cbr%2F%3EReg%3A%204k%20coords%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20Head%5BFast%20R-CNN%20Head%5D%0A%20%20%20%20%20%20%20%20H1%5BRoI%20Align%5D%0A%20%20%20%20%20%20%20%20H2%5B2x%20FC%201024%5D%0A%20%20%20%20%20%20%20%20H3%5BCls%3A%2061%20classes%3Cbr%2F%3EReg%3A%20244%20coords%5D%0A%20%20%20%20end%0A%0A%20%20%20%20C2%20--%3E%20P2%0A%20%20%20%20C3%20--%3E%20P3%0A%20%20%20%20C4%20--%3E%20P4%0A%20%20%20%20C5%20--%3E%20P5%0A%20%20%20%20P5%20--%3E%20P6%0A%0A%20%20%20%20P2%20--%3E%20RPN%0A%20%20%20%20P3%20--%3E%20RPN%0A%20%20%20%20P4%20--%3E%20RPN%0A%20%20%20%20P5%20--%3E%20RPN%0A%20%20%20%20P6%20--%3E%20RPN%0A%0A%20%20%20%20RPN%20--%3E%20Head%0A"})]),fallback:n(()=>[...s[0]||(s[0]=[k(" Loading... ",-1)])]),_:1})),s[2]||(s[2]=i(`<h3 id="_3-2-configuration-chi-tiet" tabindex="-1">3.2. Configuration Chi Tiết <a class="header-anchor" href="#_3-2-configuration-chi-tiet" aria-label="Permalink to &quot;3.2. Configuration Chi Tiết&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Component</th><th>Configuration</th></tr></thead><tbody><tr><td><strong>Framework</strong></td><td>PyTorch Detectron (Facebook AI Research)</td></tr><tr><td><strong>Backbone</strong></td><td>ResNet-50 pretrained on ImageNet</td></tr><tr><td><strong>FPN Channels</strong></td><td>256</td></tr><tr><td><strong>RPN Anchors/Location</strong></td><td>3 scales × 3 ratios = 9</td></tr><tr><td><strong>Anchor Scales</strong></td><td>32, 64, 128, 256, 512</td></tr><tr><td><strong>Anchor Ratios</strong></td><td>0.5, 1.0, 2.0</td></tr><tr><td><strong>RPN Batch Size</strong></td><td>512 (256 pos + 256 neg)</td></tr><tr><td><strong>Head Batch Size</strong></td><td>1024 (512 pos + 512 neg)</td></tr><tr><td><strong>FG/BG Ratio</strong></td><td>0.5</td></tr><tr><td><strong>NMS Threshold</strong></td><td>0.5 (training), 0.3 (inference)</td></tr></tbody></table><h3 id="_3-3-data-pipeline" tabindex="-1">3.3. Data Pipeline <a class="header-anchor" href="#_3-3-data-pipeline" aria-label="Permalink to &quot;3.3. Data Pipeline&quot;">​</a></h3><p><strong>Preprocessing:</strong></p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> preprocess_xview_image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image_path, crop_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">700</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, overlap</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Process large xView GeoTIFF images into training crops.</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Load full image (can be 3000+ pixels)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    image </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gdal.Open(image_path).ReadAsArray()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Generate overlapping crops</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    crops </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, image.shape[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> crop_size, crop_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> overlap):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, image.shape[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> crop_size, crop_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> overlap):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            crop </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image[:, y:y</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">crop_size, x:x</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">crop_size]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            crops.append({</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                &#39;image&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: crop,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                &#39;offset&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (x, y),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                &#39;source&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: image_path</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            })</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> crops</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>Augmentation pipeline:</strong></p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">transform </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> A.Compose([</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Spatial augmentations</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    A.HorizontalFlip(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    A.RandomRotate90(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 0°, 90°, 180°, 270°</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Photometric augmentations</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    A.ColorJitter(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        brightness</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        contrast</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        saturation</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        hue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.8</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Scale jittering for multi-scale training</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    A.RandomScale(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">scale_limit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Normalization</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    A.Normalize(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        mean</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.485</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.456</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.406</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        std</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.229</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.224</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.225</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ToTensorV2()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bbox_params</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A.BboxParams(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">format</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;pascal_voc&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">label_fields</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;labels&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]))</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_3-4-pre-training-rotation-augmentation" tabindex="-1">3.4. Pre-training Rotation Augmentation <a class="header-anchor" href="#_3-4-pre-training-rotation-augmentation" aria-label="Permalink to &quot;3.4. Pre-training Rotation Augmentation&quot;">​</a></h3><p>Một kỹ thuật quan trọng là tạo ra multiple rotated versions của dataset trước khi training:</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> create_rotated_dataset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(images, annotations, angles</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">90</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">180</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">270</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Pre-generate rotated versions to increase dataset size.</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Original 846 images → 63,535 crops</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    augmented_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> img, anns </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(images, annotations):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> angle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> angles:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            rotated_img </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rotate(img, angle)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            rotated_anns </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rotate_boxes(anns, angle, img.shape)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            augmented_data.append((rotated_img, rotated_anns))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> augmented_data</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><table tabindex="0"><thead><tr><th>Stage</th><th>Count</th></tr></thead><tbody><tr><td>Original images</td><td>846</td></tr><tr><td>After cropping (700×700, overlap 80)</td><td>~12,000</td></tr><tr><td>After rotation augmentation</td><td>63,535</td></tr></tbody></table><hr><h2 id="_4-huan-luyen-va-toi-uu" tabindex="-1">4. Huấn Luyện và Tối Ưu <a class="header-anchor" href="#_4-huan-luyen-va-toi-uu" aria-label="Permalink to &quot;4. Huấn Luyện và Tối Ưu&quot;">​</a></h2><h3 id="_4-1-two-phase-training-strategy" tabindex="-1">4.1. Two-Phase Training Strategy <a class="header-anchor" href="#_4-1-two-phase-training-strategy" aria-label="Permalink to &quot;4.1. Two-Phase Training Strategy&quot;">​</a></h3><p><strong>Phase 1: Base Training (200K iterations)</strong></p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">optimizer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SGD</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  lr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.005</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  momentum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.9</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  weight_decay</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.0001</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">lr_schedule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">WarmupMultiStep</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  warmup_iters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  warmup_factor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.001</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  milestones</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">120000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">160000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  gamma</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">loss</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rpn_cls</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ReducedFocalLoss(gamma=2.0, threshold=0.5)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rpn_reg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SmoothL1Loss</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rcnn_cls</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CrossEntropyLoss</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rcnn_reg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SmoothL1Loss</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">batch_size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 2 images per GPU × 2 GPUs</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>Phase 2: Fine-tuning (100K iterations)</strong></p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">optimizer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  lr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.0005</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 10× lower than Phase 1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  undersampling</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    classes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Small Car&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Building&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    drop_prob</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.5</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">loss</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Same as Phase 1 but with class balancing effects</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_4-2-hardware-va-time-requirements" tabindex="-1">4.2. Hardware và Time Requirements <a class="header-anchor" href="#_4-2-hardware-va-time-requirements" aria-label="Permalink to &quot;4.2. Hardware và Time Requirements&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Resource</th><th>Specification</th></tr></thead><tbody><tr><td><strong>GPUs</strong></td><td>2× NVIDIA (12GB+ VRAM)</td></tr><tr><td><strong>GPU Model</strong></td><td>GTX 1080 Ti or V100</td></tr><tr><td><strong>Training Time</strong></td><td>~7 days total</td></tr><tr><td><strong>Phase 1 Time</strong></td><td>~4 days</td></tr><tr><td><strong>Phase 2 Time</strong></td><td>~3 days</td></tr><tr><td><strong>Framework</strong></td><td>PyTorch 1.0, Detectron</td></tr></tbody></table><h3 id="_4-3-hyperparameter-sensitivity" tabindex="-1">4.3. Hyperparameter Sensitivity <a class="header-anchor" href="#_4-3-hyperparameter-sensitivity" aria-label="Permalink to &quot;4.3. Hyperparameter Sensitivity&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Hyperparameter</th><th>Tested Values</th><th>Best</th></tr></thead><tbody><tr><td>RFL threshold</td><td>0.3, 0.4, <strong>0.5</strong>, 0.6</td><td>0.5</td></tr><tr><td>Focal gamma</td><td>1.0, 1.5, <strong>2.0</strong>, 2.5</td><td>2.0</td></tr><tr><td>Crop size</td><td>500, 600, <strong>700</strong>, 800</td><td>700</td></tr><tr><td>Overlap</td><td>50, <strong>80</strong>, 100</td><td>80</td></tr><tr><td>Undersample prob</td><td>0.3, 0.4, <strong>0.5</strong>, 0.6</td><td>0.5</td></tr></tbody></table><h3 id="_4-4-multi-scale-training" tabindex="-1">4.4. Multi-Scale Training <a class="header-anchor" href="#_4-4-multi-scale-training" aria-label="Permalink to &quot;4.4. Multi-Scale Training&quot;">​</a></h3><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> multi_scale_train_step</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(model, images, targets, scales</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">600</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">700</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">800</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">900</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Randomly select scale for each batch.</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    scale </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> random.choice(scales)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Resize images and boxes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    resized_images </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> F.interpolate(images, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(scale, scale))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    resized_targets </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> scale_targets(targets, scale)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Forward pass</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    loss_dict </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> model(resized_images, resized_targets)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(loss_dict.values())</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><hr><h2 id="_5-ket-qua-va-phan-tich" tabindex="-1">5. Kết Quả và Phân Tích <a class="header-anchor" href="#_5-ket-qua-va-phan-tich" aria-label="Permalink to &quot;5. Kết Quả và Phân Tích&quot;">​</a></h2><h3 id="_5-1-leaderboard-performance" tabindex="-1">5.1. Leaderboard Performance <a class="header-anchor" href="#_5-1-leaderboard-performance" aria-label="Permalink to &quot;5.1. Leaderboard Performance&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Metric</th><th>Baseline</th><th>This Solution</th><th>Improvement</th></tr></thead><tbody><tr><td><strong>Public LB mAP</strong></td><td>~15</td><td>31.74</td><td>+111%</td></tr><tr><td><strong>Private LB mAP</strong></td><td>~14</td><td>29.32</td><td>+109%</td></tr><tr><td><strong>Rare Class mAP</strong></td><td>~5</td><td>~18</td><td>+260%</td></tr></tbody></table><h3 id="_5-2-ablation-study" tabindex="-1">5.2. Ablation Study <a class="header-anchor" href="#_5-2-ablation-study" aria-label="Permalink to &quot;5.2. Ablation Study&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Configuration</th><th>mAP</th><th>Δ</th></tr></thead><tbody><tr><td>Baseline (Standard CE)</td><td>24.1</td><td>-</td></tr><tr><td>+ Focal Loss (γ=2)</td><td>22.8</td><td>-1.3</td></tr><tr><td>+ Reduced Focal Loss</td><td>28.5</td><td>+4.4</td></tr><tr><td>+ Undersampling</td><td>29.8</td><td>+1.3</td></tr><tr><td>+ Ensemble (7 models)</td><td>31.74</td><td>+1.94</td></tr></tbody></table><p><strong>Key findings:</strong></p><ul><li>Standard Focal Loss actually hurts performance (-1.3 mAP)</li><li>Reduced Focal Loss provides significant gain (+4.4 mAP)</li><li>Undersampling crucial for rare classes (+1.3 mAP)</li><li>Large ensemble essential for competition winning (+1.94 mAP)</li></ul><h3 id="_5-3-per-category-analysis" tabindex="-1">5.3. Per-Category Analysis <a class="header-anchor" href="#_5-3-per-category-analysis" aria-label="Permalink to &quot;5.3. Per-Category Analysis&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Category</th><th>mAP</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Fixed-Wing Aircraft</strong></td><td>High (~45)</td><td>Clear shape, high contrast</td></tr><tr><td><strong>Helicopter</strong></td><td>High (~42)</td><td>Distinctive rotor signature</td></tr><tr><td><strong>Maritime Vessel</strong></td><td>High (~40)</td><td>Strong water contrast</td></tr><tr><td><strong>Large Vehicle</strong></td><td>Medium (~30)</td><td>Varied appearance</td></tr><tr><td><strong>Small Vehicle</strong></td><td>Medium (~25)</td><td>Size challenge</td></tr><tr><td><strong>Building</strong></td><td>Medium (~28)</td><td>Diverse architecture</td></tr><tr><td><strong>Railway Vehicle</strong></td><td>Low (~12)</td><td>Very rare class</td></tr><tr><td><strong>Tower</strong></td><td>Low (~10)</td><td>Limited training data</td></tr></tbody></table><h3 id="_5-4-ensemble-strategy" tabindex="-1">5.4. Ensemble Strategy <a class="header-anchor" href="#_5-4-ensemble-strategy" aria-label="Permalink to &quot;5.4. Ensemble Strategy&quot;">​</a></h3><p><strong>7-Model Ensemble:</strong></p><table tabindex="0"><thead><tr><th>Model</th><th>Backbone</th><th>Crop Size</th><th>mAP</th></tr></thead><tbody><tr><td>M1</td><td>ResNet-50</td><td>700×700</td><td>28.5</td></tr><tr><td>M2</td><td>ResNet-50</td><td>800×800</td><td>29.1</td></tr><tr><td>M3</td><td>ResNet-101</td><td>700×700</td><td>29.8</td></tr><tr><td>M4</td><td>ResNeXt-101</td><td>700×700</td><td>30.2</td></tr><tr><td>M5</td><td>ResNet-50</td><td>600×600</td><td>27.8</td></tr><tr><td>M6</td><td>ResNet-101</td><td>800×800</td><td>30.0</td></tr><tr><td>M7</td><td>ResNeXt-101</td><td>800×800</td><td>30.5</td></tr><tr><td><strong>Ensemble</strong></td><td>-</td><td>-</td><td><strong>31.74</strong></td></tr></tbody></table><p><strong>Ensemble method:</strong> Weighted box fusion với NMS threshold 0.3</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ensemble_predictions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(all_predictions, weights, nms_threshold</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Combine predictions from multiple models.</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    merged_boxes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    merged_scores </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    merged_labels </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pred, weight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(all_predictions, weights):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        merged_boxes.extend(pred[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;boxes&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        merged_scores.extend([s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> weight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pred[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;scores&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        merged_labels.extend(pred[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;labels&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Apply NMS</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    keep </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nms(merged_boxes, merged_scores, nms_threshold)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;boxes&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [merged_boxes[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> keep],</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;scores&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [merged_scores[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> keep],</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;labels&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [merged_labels[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> keep]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><hr><h2 id="_6-tai-tao-va-tai-nguyen" tabindex="-1">6. Tái Tạo và Tài Nguyên <a class="header-anchor" href="#_6-tai-tao-va-tai-nguyen" aria-label="Permalink to &quot;6. Tái Tạo và Tài Nguyên&quot;">​</a></h2><h3 id="_6-1-code-availability" tabindex="-1">6.1. Code Availability <a class="header-anchor" href="#_6-1-code-availability" aria-label="Permalink to &quot;6.1. Code Availability&quot;">​</a></h3><p>Giải pháp dựa trên Detectron framework với các modifications sau:</p><ul><li>Custom Reduced Focal Loss implementation</li><li>Modified RPN với class-balanced sampling</li><li>Ensemble inference script</li><li>xView-specific data loader</li></ul><h3 id="_6-2-dependencies" tabindex="-1">6.2. Dependencies <a class="header-anchor" href="#_6-2-dependencies" aria-label="Permalink to &quot;6.2. Dependencies&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># Core</span></span>
<span class="line"><span>pytorch &gt;= 1.0</span></span>
<span class="line"><span>torchvision &gt;= 0.2.1</span></span>
<span class="line"><span>detectron (Facebook AI Research)</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Data processing</span></span>
<span class="line"><span>gdal &gt;= 2.3</span></span>
<span class="line"><span>opencv-python &gt;= 4.0</span></span>
<span class="line"><span>pycocotools &gt;= 2.0</span></span>
<span class="line"><span>albumentations &gt;= 0.5</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Utilities</span></span>
<span class="line"><span>tqdm</span></span>
<span class="line"><span>tensorboard</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_6-3-reproduction-steps" tabindex="-1">6.3. Reproduction Steps <a class="header-anchor" href="#_6-3-reproduction-steps" aria-label="Permalink to &quot;6.3. Reproduction Steps&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. Clone Detectron và apply patches</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/facebookresearch/Detectron</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Detectron</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">python</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> setup.py</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. Download xView dataset</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wget</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://xviewdataset.org/download</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. Preprocess data</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">python</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preprocess_xview.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --input_dir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /path/to/xview</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                           --output_dir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /path/to/crops</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                           --crop_size</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 700</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                           --overlap</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 80</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 4. Train Phase 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">python</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> train_net.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configs/xview_rcnn_r50_fpn_phase1.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 5. Train Phase 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">python</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> train_net.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configs/xview_rcnn_r50_fpn_phase2.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                    --resume</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /path/to/phase1/model.pth</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 6. Inference</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">python</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> inference.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configs/xview_rcnn_r50_fpn.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                    --weights</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /path/to/model.pth</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                    --input</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /path/to/test_images</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_6-4-citation" tabindex="-1">6.4. Citation <a class="header-anchor" href="#_6-4-citation" aria-label="Permalink to &quot;6.4. Citation&quot;">​</a></h3><div class="language-bibtex vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bibtex</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@article</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sergievskiy2019reduced</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  title</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Reduced Focal Loss: 1st Place Solution to xView object</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         detection in Satellite Imagery</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  author</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Sergievskiy, Nikolay and Ponamarev, Alexander</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  journal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arXiv preprint arXiv:1903.01347</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  year</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">2019</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_6-5-tai-nguyen-ben-ngoai" tabindex="-1">6.5. Tài Nguyên Bên Ngoài <a class="header-anchor" href="#_6-5-tai-nguyen-ben-ngoai" aria-label="Permalink to &quot;6.5. Tài Nguyên Bên Ngoài&quot;">​</a></h3><ul><li><strong>Paper:</strong> <a href="https://arxiv.org/abs/1903.01347" target="_blank" rel="noreferrer">arXiv:1903.01347</a></li><li><strong>Dataset:</strong> <a href="https://xviewdataset.org" target="_blank" rel="noreferrer">xviewdataset.org</a></li><li><strong>Detectron:</strong> <a href="https://github.com/facebookresearch/Detectron" target="_blank" rel="noreferrer">github.com/facebookresearch/Detectron</a></li><li><strong>Competition:</strong> <a href="https://www.diu.mil/ai-xview-challenge" target="_blank" rel="noreferrer">DIU xView Challenge</a></li></ul><hr><h2 id="phu-luc" tabindex="-1">Phụ Lục <a class="header-anchor" href="#phu-luc" aria-label="Permalink to &quot;Phụ Lục&quot;">​</a></h2><h3 id="a-reduced-focal-loss-full-implementation" tabindex="-1">A. Reduced Focal Loss - Full Implementation <a class="header-anchor" href="#a-reduced-focal-loss-full-implementation" aria-label="Permalink to &quot;A. Reduced Focal Loss - Full Implementation&quot;">​</a></h3><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.nn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nn</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.nn.functional </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> F</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReducedFocalLoss</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Reduced Focal Loss for Region Proposal Network.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Args:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        gamma: Focusing parameter (default: 2.0)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        threshold: Probability threshold for applying focal weighting (default: 0.5)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        alpha: Class balancing factor (default: 0.25)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __init__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, gamma</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, threshold</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, alpha</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.25</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, reduction</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;mean&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        super</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">__init__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.gamma </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gamma</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.threshold </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> threshold</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.alpha </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> alpha</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.reduction </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reduction</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> forward</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, inputs, targets):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        Args:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            inputs: Predicted logits (N, *)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            targets: Ground truth labels (N, *)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        Returns:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            loss: Scalar loss value</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Compute probabilities</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.sigmoid(inputs)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        pt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.where(targets </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, p, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Compute base cross-entropy</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ce_loss </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> F.binary_cross_entropy_with_logits(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            inputs, targets, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">reduction</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;none&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Compute focal weight based on threshold</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        focal_weight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.where(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            pt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.threshold,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            torch.ones_like(pt),  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Below threshold: weight = 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pt) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.gamma) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.threshold </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.gamma)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Apply alpha balancing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        alpha_t </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.where(targets </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.alpha, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.alpha)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Final loss</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        loss </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> alpha_t </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> focal_weight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ce_loss</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.reduction </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;mean&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loss.mean()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        elif</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.reduction </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;sum&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loss.sum()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loss</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="b-performance-metrics-by-class-group" tabindex="-1">B. Performance Metrics by Class Group <a class="header-anchor" href="#b-performance-metrics-by-class-group" aria-label="Permalink to &quot;B. Performance Metrics by Class Group&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Class Group</th><th># Classes</th><th># Instances</th><th>Avg mAP</th></tr></thead><tbody><tr><td>Aircraft</td><td>6</td><td>~25K</td><td>42.3</td></tr><tr><td>Vehicles</td><td>12</td><td>~450K</td><td>26.8</td></tr><tr><td>Maritime</td><td>8</td><td>~35K</td><td>38.5</td></tr><tr><td>Buildings</td><td>5</td><td>~380K</td><td>27.2</td></tr><tr><td>Infrastructure</td><td>10</td><td>~50K</td><td>22.1</td></tr><tr><td>Other</td><td>19</td><td>~60K</td><td>18.5</td></tr></tbody></table><hr><p><em>Tài liệu tạo: 2024-12-18</em><em>Cập nhật lần cuối: 2025-12-19</em><em>Số từ: ~4,200</em></p>`,60))])}const D=e(c,[["render",o]]);export{A as __pageData,D as default};
